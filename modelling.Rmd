---
title: "Modelling: Identity and Reintegration"
output: html_document
date: "2023-12-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Which outcome variable(s) and their arrangement?
Which explanatory variable(s) and their arrangement?
Include/not the unmet needs/unplanned discharge mechanism
Military identity centrality as a moderator? Other mediators or moderators
Antecedent variables, possible connections to the other variables (i.e. backdoor path)





WIS Family, higher score = greater loss but also greater identity, in a way. So it is

WIS Family Items:
18. I miss my military friends. 
19. I wish I could go back into the military. 
20. By leaving the military I lost a family. 

WIS Interdependent Items:  
8. Only other veterans can truly understand me.
9. When I meet other veterans I can trust them more quickly than other people.
10. I become friends with other veterans more quickly than with non-veterans. 
11. My fate and future are bound up with that of veterans. 
12. Regarding other veterans, it is accurate to say, “United we stand, divided we fall.” 
13. The most important things that have happened in my life involve my military service. 
14. When I talk about the military, I usually say ‘we’ rather than ‘they.’ 

WIS Centrality Items:  
21. Overall, having served in the military has very little to do with how I feel about myself.*
22. In general, being a veteran is an important part of my self-image.
23. Being a veteran is unimportant to my sense of what kind of person I am.*
24. Being a veteran is not a major factor in my social relationships.*



```{r}
data %>% 
  ggplot(aes(wis_interdependent_total, wis_family_total)) +
  geom_point()
  
data %>% 
  ggplot(aes(wis_centrality_total, wis_family_total)) +
  geom_point() +
  geom_smooth()

data %>% 
  ggplot(aes(wis_centrality_total, wis_interdependent_total)) +
  geom_point()
```


 
A correlation analysis of the WIS variable suggests most of the subscales have moderate to strong positive correlations with each other. Peercieved public regard is an exception. 

Interdependence and family seem highly correlated

Centrality is strongly correlated with everything except public regard 
Family is correlated with every but varies from r = .3 to r = .7, not including public regard

Family, Connection, Pride

```{r}
data %>% 
  select(starts_with('wis') & ends_with('total') & !wis_total) %>% 
  corrr::correlate(method = "pearson",
                   use = "pairwise.complete.obs",
                   quiet = T) %>% 
  mutate(across(2:8, ~ round(.x, digits = 2))) %>% 
  kableExtra::kbl() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

data %>% 
  select(wis_family_total, wis_connection_total, wis_private_regard_total, wis_public_regard_total, biis_harmony) %>% 
  corrr::correlate(method = "pearson",
                   use = "pairwise.complete.obs",
                   quiet = T) %>% 
  mutate(across(2:5, ~ round(.x, digits = 2))) %>% 
  kableExtra::kbl() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"))



# WIS --------------------------------------------------------------------

data %>% select(starts_with('wis')) %>% psych::describe()


```




International consistency for WIS

Family is okay, $\alpha = .76$
Centrality is okay, $\alpha = .79$
Connection is not as good, $\alpha = .68$
Interdependence is good, $\alpha = .81$
Private regard is strong, $\alpha = .88$
Public regard is strong, $\alpha = .85$
Skills is worse, $\alpha = .61$

all the items together = $\alpha = .92$

```{r}
data %>% 
  select(starts_with('wis_centrality') & !ends_with('total')) %>%
  psych::alpha()

data %>% 
  select(starts_with('wis_centrality') & !ends_with('total')) %>%
  psych::omega(nfactors = 1)

data %>% 
  select(starts_with('wis_connection') & !ends_with('total')) %>%
  psych::alpha()

data %>% 
  select(starts_with('wis_family') & !ends_with('total')) %>%
  psych::alpha()


data %>% 
  select(starts_with('wis_inter') & !ends_with('total')) %>%
  psych::alpha()

data %>% 
  select(starts_with('wis_private') & !ends_with('total')) %>%
  psych::alpha()

data %>% 
  select(starts_with('wis_public') & !ends_with('total')) %>%
  psych::alpha()

data %>% 
  select(starts_with('wis_skills') & !ends_with('total')) %>%
  psych::alpha()

data %>% 
  select(starts_with('wis_') & !ends_with('total')) %>%
  psych::alpha()

data %>% 
  select(starts_with('wis_') & !starts_with('wis_pub') & !ends_with('total')) %>%
  psych::alpha()
```



Flack and Kite reduced their subscales. In the case of my data, Cronbach's alpha is lower for the Flack and Kite subscales than the original for Private Regard, Interdependence, and Centrality. In fairness, they dropped these in the context of fitting these identity variables as predictors of social connectedness and wellbeing. 

(Connection and Family were not reduced - already 3 items each; Public Regard was not reduced. Skills was removed)


```{r}

data %>% 
  select(wis_private_2, wis_private_3,wis_private_4,wis_private_6) %>%
  psych::alpha()


data %>% 
  select(wis_interdependent_8, wis_interdependent_9,wis_interdependent_10) %>%
  psych::alpha()


data %>% 
  select(wis_centrality_22, wis_centrality_23, wis_centrality_24) %>%
  psych::alpha()


```



Let's try a factor analysis of the WIS

```{r}

library(lavaan)

## Internal Consistency

## SEM
model_cfa_wis_31 <-
  '
  centrality =~ wis_centrality_21 + wis_centrality_22 + wis_centrality_23 + wis_centrality_24    
  connection =~ wis_connection_15 + wis_connection_16 + wis_connection_17
  family =~ wis_family_18 + wis_family_19 + wis_family_20
  interdependent =~ wis_interdependent_8 + wis_interdependent_9 + wis_interdependent_10 + wis_interdependent_11 + wis_interdependent_12 + wis_interdependent_13 + wis_interdependent_14
  public =~ wis_public_25 + wis_public_26 + wis_public_27 + wis_public_28
  private =~ wis_private_1 + wis_private_2 + wis_private_3 + wis_private_4 + wis_private_5 + wis_private_6 + wis_private_7
  skills =~ wis_skills_29 + wis_skills_30 + wis_skills_31
  xwis =~ 1 * centrality + 1 * connection + 1 * family + 1 * interdependent + 1 * public + 1 * private + 1 * skills
  
    wis ~~ wis'
fit_cfa_wis_31 <- lavaan::cfa(model_cfa_wis_31, data = data)
fit_cfa_wis_31 %>% summary(fit.measures = T, standardized = T)
fit_cfa_wis_31 %>% semPlot::semPaths(curvePivot = TRUE)
lavaan::standardizedsolution(fit_cfa_wis_31)

# Fit Measures:
lavaan::fitMeasures(fit_cfa_wis_31)

# Factor Loadings:
lavaan::inspect(fit_cfa_wis_31, what = "std")$lambda

# EFA ------------------------------------------------------------------
model_efa_wis_31 <-
  data %>% 
  select(starts_with('wis') & 
           !ends_with('total')) %>% 
  lavaan::efa(nfactors = 7) 

model_efa_wis_31_sum <- 
  model_efa_wis_31 %>% 
  summary()
model_efa_wis_31_sum

```






```{r}
data %>% 
  lm(m2cq_mean ~ wis_centrality_total, data = .) %>% 
  lm.beta::lm.beta() %>% summary()

data %>% 
  lm(m2cq_mean ~ wis_family_total, data = .) %>% 
  lm.beta::lm.beta() %>% summary()

data %>% 
  lm(m2cq_mean ~ wis_private_regard_total, data = .) %>% 
  lm.beta::lm.beta() %>% summary()

data %>% 
  lm(m2cq_mean ~ wis_public_regard_total, data = .) %>% 
  lm.beta::lm.beta() %>% summary()

data %>% 
  lm(m2cq_mean ~ wis_interdependent_total, data = .) %>% 
  lm.beta::lm.beta() %>% summary()

data %>% 
  lm(m2cq_mean ~ wis_family_total + wis_private_regard_total + wis_public_regard_total + wis_interdependent_total, data = .) %>% 
  lm.beta::lm.beta() %>% summary()



```


At different levels of centrality, identity loss may be worse

```{r}
data %>% 
  lm(m2cq_mean ~ wis_family_total + wis_centrality_total + wis_family_total * wis_centrality_total, data = .) %>% 
  lm.beta::lm.beta() %>% summary()



```


Control for unplanned discharge and needs


```{r}
data %>% 
  lm(m2cq_mean ~ wis_family_total + wis_centrality_total + wis_family_total * wis_centrality_total + unmet_needs_total + discharge_reason, data = .) %>% 
  lm.beta::lm.beta() %>% summary()



```

ADD ANTECEDENTS


```{r}
data %>% count(race)


data %>% 
  lm(m2cq_mean ~ 
       wis_family_total + 
       wis_centrality_total + 
       wis_family_total * wis_centrality_total + 
       unmet_needs_total + 
       discharge_reason +
       race_white + race_black +
       sex_male +
       military_exp_combat, 
     data = .) %>% 
  lm.beta::lm.beta() %>% summary()



```



Great. But now what about the othe identity varaibles?

The multifaceted view suggests these are all different aspects of identity, but then do they all share a common source -- a general identity strength?

The theory still matters. Acculturation and bicultural identity integration is also largely apart from the theories of identity that Ashford analyzed to arrive at the facets of identity. So, is it an additional variable? Or does it capture what the WIS military as familiy does? Those have the highest correlations.


```{r}
data %>% count(race)


data %>% 
  lm(m2cq_mean ~ 
       wis_family_total + 
       wis_centrality_total + 
       wis_family_total * wis_centrality_total + 
       biis_harmony +
       civilian_commit_total +
       unmet_needs_total + 
       discharge_reason +
       race_white + race_black +
       sex_male +
       military_exp_combat, 
     data = .) %>% 
  lm.beta::lm.beta() %>% 
  summary()





```




```{r}

data %>% 
  lm(biis_harmony ~ 
       wis_family_total + 
       civilian_commit_total + 
       race_white + race_black +
       sex_male +
       military_exp_combat, 
     data = .) %>% 
  lm.beta::lm.beta() %>% 
  summary()

```

MODEL E from the powerpoint

```{r}


library(lavaan) 

sem_model_1 = '
  
  m2cq_mean ~ c1 * wis_family_total + wis_centrality_total + wis_family_total:wis_centrality_total + b * biis_harmony + c2* civilian_commit_total + unmet_needs_total + discharge_reason + race_white + race_black + sex_male + military_exp_combat
  biis_harmony ~ a1* wis_family_total + a2* civilian_commit_total + race_white + race_black + sex_male + military_exp_combat 
 
  # direct effect
  direct_mil := c1
  direct_civ := c2
 
  # indirect effect
  indirect_mil := a1*b
  indirect_civ := a2*b
  
  contrast := (a1*b) - (a2*b)
 
  # total effect
  total := c1 + c2 + (a1 + a2) * b

'

set.seed(876433112, kind = "Mersenne-Twister") # Set for replication

fit_1 <- sem(model = sem_model_1,
                       data = data
                       #se = "bootstrap",
                       #bootstrap = 5000,
                       #parallel ="snow", 
                       #ncpus = parallel::detectCores()
           )


fit_1 %>% summary(standardized = TRUE, rsq = TRUE, ci = TRUE) %>% print()

fit_1 %>% 
  lavaan::fitMeasures(c('chisq', 'df', 'pvalue', 'cfi', 'gfi', 'nnfi', 'nfi', 'rmsea', 'rmesea.ci.upper', 'rmesea.ci.lower', 'srmr', 'AIC'))


fit_1 %>% lavaan::fitMeasures('AIC')
```




ADD AN INTERACTION BETWEEN MIL AND CIV

```{r}


library(lavaan) 

sem_model_2 = '
  
  m2cq_mean ~ c1 * wis_family_total + wis_centrality_total + wis_family_total:wis_centrality_total + b * biis_harmony + c2* civilian_commit_total + unmet_needs_total + discharge_reason + race_white + race_black + sex_male + military_exp_combat
  biis_harmony ~ a1* wis_family_total + a2* civilian_commit_total + wis_family_total:civilian_commit_total + race_white + race_black + sex_male + military_exp_combat 
 
  # direct effect
  direct_mil := c1
  direct_civ := c2
 
  # indirect effect
  indirect_mil := a1*b
  indirect_civ := a2*b
  
  contrast := (a1*b) - (a2*b)
 
  # total effect
  total := c1 + c2 + (a1 + a2) * b

'

set.seed(876433112, kind = "Mersenne-Twister") # Set for replication

fit_2 <- sem(model = sem_model_2,
                       data = data
                       #se = "bootstrap",
                       #bootstrap = 5000,
                       #parallel ="snow", 
                       #ncpus = parallel::detectCores()
           )


fit_2 %>% summary(standardized = TRUE, rsq = TRUE, ci = TRUE) %>% print()

fit_2 %>% 
  lavaan::fitMeasures(c('chisq', 'df', 'pvalue', 'cfi', 'gfi', 'nnfi', 'nfi', 'rmsea', 'rmesea.ci.upper', 'rmesea.ci.lower', 'srmr', 'AIC'))


fit_1 %>% lavaan::fitMeasures('AIC')
fit_2 %>% lavaan::fitMeasures('AIC')



```





BIG MODEL

```{r}


library(lavaan) 

sem_model_3 = '
  
  m2cq_mean ~ 1 + mcarm_beliefs_about_civilians + mcarm_help_seeking + c1 * wis_family_total + wis_centrality_total + wis_family_total:wis_centrality_total + b * biis_harmony + c2* civilian_commit_total + unmet_needs_total + discharge_reason + race_white + race_black + sex_male + military_exp_combat
  
  biis_harmony ~ 1 + a1* wis_family_total + a2* civilian_commit_total + wis_family_total:civilian_commit_total + race_white + race_black + sex_male + military_exp_combat 
  
  mcarm_help_seeking ~ 1 + wis_family_total + biis_harmony
  mcarm_beliefs_about_civilians ~ 1 + civilian_commit_total + biis_harmony
 
  # direct effect
  direct_mil := c1
  direct_civ := c2
 
  # indirect effect
  indirect_mil := a1*b
  indirect_civ := a2*b
  
  contrast := (a1*b) - (a2*b)
 
  # total effect
  total := c1 + c2 + (a1 + a2) * b

'

set.seed(876433112, kind = "Mersenne-Twister") # Set for replication

fit_3 <- sem(model = sem_model_3,
                       data = data
                       #se = "bootstrap",
                       #bootstrap = 5000,
                       #parallel ="snow", 
                       #ncpus = parallel::detectCores()
           )


fit_3 %>% summary(standardized = TRUE, rsq = TRUE, ci = TRUE) %>% print()

fit_3 %>% 
  lavaan::fitMeasures(c('chisq', 'df', 'pvalue', 'cfi', 'gfi', 'nnfi', 'nfi', 'rmsea', 'rmesea.ci.upper', 'rmesea.ci.lower', 'srmr', 'AIC'))


fit_1 %>% lavaan::fitMeasures('AIC')
fit_2 %>% lavaan::fitMeasures('AIC')
fit_3 %>% lavaan::fitMeasures('AIC')



```





BIG MODEL WITH MEASUREMENT

```{r}


library(lavaan) 

sem_model_3 = '
  
  m2cq_mean ~ 1 + civilian_commit_total_l + unmet_needs_total + discharge_reason + race_white + race_black + sex_male + military_exp_combat
  
 civilian_commit_total_l =~ civilian_commit_1 + civilian_commit_2 + civilian_commit_3 + civilian_commit_4
 
'

set.seed(876433112, kind = "Mersenne-Twister") # Set for replication

fit_3 <- sem(model = sem_model_3,
                       data = data
                       #se = "bootstrap",
                       #bootstrap = 5000,
                       #parallel ="snow", 
                       #ncpus = parallel::detectCores()
           )


fit_3 %>% summary(standardized = TRUE, rsq = TRUE, ci = TRUE) %>% print()

fit_3 %>% 
  lavaan::fitMeasures(c('chisq', 'df', 'pvalue', 'cfi', 'gfi', 'nnfi', 'nfi', 'rmsea', 'rmesea.ci.upper', 'rmesea.ci.lower', 'srmr', 'AIC'))


fit_1 %>% lavaan::fitMeasures('AIC')
fit_2 %>% lavaan::fitMeasures('AIC')
fit_3 %>% lavaan::fitMeasures('AIC')



```




# PROCESS


### Mediation is model 4
```{r}

process(data = data, y = "m2cq_mean", x = "wis_centrality_total", m = "mcarm_help_seeking", model = 4)

```



### Moderation is model 1
```{r}

process(data = data, y = "m2cq_mean", x = "wis_centrality_total", w = "mcarm_help_seeking", model = 1)






```



Standardize the data for interaction. Otherwise the different scales make the interaction term impossible to interpret.

```{r}

data <-
  data %>% 
  mutate(
    m2cq_mean_z = scale(m2cq_mean), 
    wis_centrality_total_z = scale(wis_centrality_total),
    mcarm_help_seeking_z = scale(mcarm_help_seeking))


process(data = data, y = "m2cq_mean_z", x = "wis_centrality_total_z", w = "mcarm_help_seeking_z", model = 1)

```


Now run with the hypothesized antecdent variables as covariates
```{r}

process(data = data, y = "m2cq_mean_z", x = "wis_centrality_total_z", w = "mcarm_help_seeking_z", 
        cov = c('race_white', 'race_black', 'sex_male', 'military_exp_combat'), model = 1)

```






```{r}


library(lavaan) 

mediation_controls = '
  
  m2cq_mean ~ 1 + wis_centrality_total + mcarm_help_seeking + unmet_needs_total + discharge_other + discharge_medical + race_white + race_black + sex_male + military_exp_combat
  mcarm_help_seeking ~ 1 + wis_centrality_total + unmet_needs_total + discharge_other + discharge_medical + race_white + race_black + sex_male + military_exp_combat
  unmet_needs_total ~ 1 + wis_centrality_total + discharge_other + discharge_medical
 
'

set.seed(876433112, kind = "Mersenne-Twister") # Set for replication

fit_mediation <- sem(model = mediation_controls,
                       data = data
                       #se = "bootstrap",
                       #bootstrap = 5000,
                       #parallel ="snow", 
                       #ncpus = parallel::detectCores()
           )


fit_mediation %>% summary(standardized = T, rsq = TRUE, ci = TRUE) %>% print()

fit_mediation %>% 
  lavaan::fitMeasures(c('chisq', 'df', 'pvalue', 'cfi', 'gfi', 'nnfi', 'nfi', 'rmsea', 'rmesea.ci.upper', 'rmesea.ci.lower', 'srmr', 'AIC'))




```