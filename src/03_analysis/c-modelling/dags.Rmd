---
title: "Directed Acyclical Graphs: "
output: html_document
date: "2024-01-14"
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(dagitty)
library(ggdag)

```


## 1. Bivariate

```{r, echo = FALSE}

dag_bivariate <- 
  
  dagify('ID' ~ 'MI',
         exposure = 'MI', 
         outcome = 'ID')


ggdag::tidy_dagitty(dag_bivariate)

coordinates(dag_bivariate) <- list(
  x = c(MI = 0, ID = 1),
  y = c(
    MI = 1, 
    ID = 1
        )
)

(plot_bivariate <-
  ggdag(dag_bivariate) +
  geom_dag_point(fill = 'white', color = 'white') +
  geom_dag_edges() +
  geom_dag_text(color = 'black', size = 5) +
  theme_dag() +
  labs(title = 'Graphical Model: Bivariate')
)

ggsave(here::here('output/figures/graphical-models/dag_bivariate.jpeg'),
       plot = plot_bivariate)

adjustmentSets(dag_bivariate)

(plot_bivariate_adj_set <- 
  ggdag_adjustment_set(dag_bivariate) + 
    theme_dag() +
  labs(title = 'Graphical Model: Bivariate')
  )

ggsave(here::here('output/figures/graphical-models/dag_bivariate_adj_set.jpeg'))
```


## 2. The Chain of Events

### 2a. Combat, Critical Incidents, Moral Injury, and PTSD
Moral Injury Symptoms result from potentially morally injurious events or experiences. These are more likely to occur in combat which could also affect identity. This DAG depicts this longer chain. 

Critical incidents may also result in PTSD besides MI. 


```{r, echo = FALSE}

dag_chain <- 
  
  dagify('ID' ~ 'MI' + 'PTSD' + 'Combat',
         'CritIn' ~ 'Combat',
         'PTSD' ~ 'CritIn',
         'MI' ~ 'CritIn',
         
         exposure = 'MI', 
         outcome = 'ID')


ggdag::tidy_dagitty(dag_chain)

coordinates(dag_chain) <- list(
  x = c(Combat = .75, CritIn = .5, MI = .75, PTSD = .75, ID = 1),
  y = c(
    PTSD = 1.03,
    ID = 1,
    MI = .97, 
    Combat = 1.25,
    CritIn = 1
        )
)

(plot_chain <-
ggdag(dag_chain) +
  geom_dag_point(colour = 'white', fill = 'white') +
  geom_dag_edges() +
  geom_dag_text(color = 'black', size = 5) +
  theme_dag() +
  labs(title = 'Graphical Model: Chain of Events')
)

ggsave(here::here('output/figures/graphical-models/dag_chain.jpeg'),
       plot = plot_chain)


adjustmentSets(dag_chain)

(plot_chain_adj_set <-
ggdag_adjustment_set(dag_chain) + theme_dag() +
  labs(title = 'Graphical Model: Chain of Events')
)

ggsave(here::here('output/figures/graphical-models/dag_chain_adj_set.jpeg'),
       plot = plot_chain_adj_set)
```



## 3. Thinking longitudinally


### 3a. Longitudinal DAG

The data for the current study is cross sectional, but the phenomenon I am studying actually occurs over time. While gathering longitudinal data to assess my research question is somewhat unfeasible (it would require a cohort study, tracking military identity before and after exposure to critical incidents). Experiments would be unethical (i.e., causing someone to experience a critical incident).

Nevertheless, I can graphically model the longitudinal aspects. Note the adjustment sets require   Military Identity at time 1 which is unobserved. 


```{r, echo = FALSE}

dag_long <- 
  
  dagify('ID2' ~ 'MI' + 'PTSD' + 'Combat' + 'ID1u',
         'ID1u' ~ 'Combat',
         'CritIn' ~ 'Combat',
         'PTSD' ~ 'CritIn' + 'ID1u',
         'MI' ~ 'CritIn' + 'ID1u',
         
         exposure = 'MI', 
         outcome = 'ID2')


ggdag::tidy_dagitty(dag_long)

coordinates(dag_long) <- list(
  x = c(Combat = .75, CritIn = .5, MI = .75, ID1u = .65, PTSD = .75, ID2 = 1),
  y = c(
    ID1u = 1.09,
    PTSD = 1.03,
    ID2 = 1,
    MI = .97, 
    Combat = 1.25,
    CritIn = 1
        )
)

(plot_long <-
ggdag(dag_long) + 
  geom_dag_point(colour = 'white') + 
  geom_dag_edges() + 
  geom_dag_text(color = 'black', size = 5) + 
  theme_dag() +
  labs(title = 'Graphical Model: Longitudinal')
)

ggsave(here::here('output/figures/graphical-models/dag_long.jpeg'),
       plot = plot_long)

adjustmentSets(dag_long)

(plot_long_adj_set <-
ggdag_adjustment_set(dag_long) +
  labs(title = 'Graphical Model: Longitudinal')
)

ggsave(here::here('output/figures/graphical-models/dag_long_adj_set.jpeg'),
       plot = plot_long_adj_set)
```


### 3b. Longitudinal DAG: Critical Incidents as the exposure

Changing the exposure variable changes the adjustment set. In this case, exposure to the critical incident could be a proxy for subsequent moral injury. This change means the unobserved military identity at time 1 is no longer needed to adjust the model. Knowing Military ID at time one would still improve the precision of this estimate, and using critical incident instead of Moral Injury  symptoms is theoretically (and statistically) weaker. 

This also suggests that Critical Incident may be a good instrumental variable. It shouldn't be directly related to identity either at time 1 or time 2. We will add additional control variables below, some of which may link Critical Incidents to the outcome through other variables, spoiling the use of Critical Incidents as an Instrumental Variable. 


```{r, echo = FALSE}

dag_long_crit <- 
  
  dagify('ID2' ~ 'MI' + 'PTSD' + 'Combat' + 'ID1u',
         'ID1u' ~ 'Combat',
         'CritIn' ~ 'Combat',
         'PTSD' ~ 'CritIn' + 'ID1u',
         'MI' ~ 'CritIn' + 'ID1u',
         
         exposure = 'CritIn', 
         outcome = 'ID2')


ggdag::tidy_dagitty(dag_long_crit)

coordinates(dag_long_crit) <- list(
  x = c(Combat = .75, CritIn = .5, MI = .75, ID1u = .65, PTSD = .75, ID2 = 1),
  y = c(ID1u = 1.09, PTSD = 1.03, ID2 = 1, MI = .97,  Combat = 1.25, CritIn = 1))

(plot_dag_long_crit <-
ggdag(dag_long_crit) + 
  geom_dag_point(colour = 'white') + 
  geom_dag_edges() + 
  geom_dag_text(color = 'black', size = 5) + 
  theme_dag() +
  labs(title = 'Graphical Model: Longitudinal + Critical Indicident as Explanatory Variable')
)

ggsave(here::here('output/figures/graphical-models/dag_long_crit.jpeg'),
       plot = plot_dag_long_crit)

adjustmentSets(dag_long_crit)

(plot_long_crit_adj_set <-
  ggdag_adjustment_set(dag_long_crit) +
    theme_dag() +
    labs(title = 'Graphical Model: Longitudinal + Critical Indicident as Explanatory Variable')
)


ggsave(here::here('output/figures/graphical-models/dag_long_crit_adj_set.jpeg'),
       plot = plot_long_crit_adj_set)
```

### 3c. Using a proxy for Identity at Time 1. 

With cross sectional data, it is not possible to assess military identity at time 1. However, the data did ask if other family members served in the military, including parents and siblings. 

It is possible that this works as a type of proxy variable for military identity at time 1, allowing for estimation of military identity at time 1. Together with the demographic variables I introduce below in step 4, this military family variable might explain some of the variance that would be better explained by measuring identity at time 1. 


```{r, echo = FALSE}

dag_long_fam <- 
  
  dagify('ID2' ~ 'MI' + 'PTSD' + 'Combat' + 'ID1u',
         'ID1u' ~ 'Combat' + 'MilFam',
         'CritIn' ~ 'Combat',
         'PTSD' ~ 'CritIn' + 'ID1u',
         'MI' ~ 'CritIn' + 'ID1u',
         
         exposure = 'MI', 
         outcome = 'ID2')


ggdag::tidy_dagitty(dag_long_fam)

coordinates(dag_long_fam) <- list(
  x = c(CritIn = .5, MilFam = .6,  Combat = .75, MI = .75, ID1u = .65, PTSD = .75, ID2 = 1),
  y = c(ID1u = 1.09, MilFam = 1.15, PTSD = 1.03, ID2 = 1, MI = .97,  Combat = 1.25, CritIn = 1))

(plot_long_fam <-
ggdag(dag_long_fam) + 
  geom_dag_point(colour = 'white') + 
  geom_dag_edges() + 
  geom_dag_text(color = 'black', size = 5) + 
  theme_dag() +
  labs(title = 'Graphical Model: Longitudinal + Proxy for Military Identity 1')
)

ggsave(here::here('output/figures/graphical-models/dag_long_fam.jpeg'),
       plot = plot_long_fam)

adjustmentSets(dag_long_fam)

(plot_long_fam_adj_set <-
ggdag_adjustment_set(dag_long_fam) +
    theme_dag() +
    labs(title = 'Graphical Model: Longitudinal + Proxy for Military Identity 1')
)

ggsave(here::here('output/figures/graphical-models/dag_long_fam_adj_set.jpeg'),
       plot = plot_long_fam_adj_set)

```

## 4. Covariates

### 4a. Demographics
These pre-service, demographic variable may have wide ranging affects on human experience -- race/ethnicity, sex/gender, and officer/enlisted personnel, which is related to pre-service socioeconomic status via the requirement for officers to have college degrees. 

Race and sex may certainly affect a person's identity. they may also change a person's chances of being exposed to a critical incident, particularly military sexual trauma for female veterans. Symptoms may similarly be affected.

To the extent that these antecdent controls (Sex, Race, Officer) impact identity at time 1 and time 2, then including them in the model should help reduce the impact of the unobserved identity at time 1. 

Interestingly, however, these variables shouldn't be related to coming from a military family, and I would say they do not affect the likelihood that someone goes to combat -- I could be wrong here. Females may still deploy to combat less; some races may go to combat more.

At this point, the graph of the DAG becomes bushy and difficult to read. 



```{r, echo = FALSE}

dag_demos <- 
  
  dagify('ID2' ~ 'MI' + 'PTSD' + 'Combat' + 'ID1u' + 'Race' + 'Sex' + 'Officer',
         'ID1u' ~ 'Combat' + 'MilFam' + 'Race' + 'Sex' + 'Officer',
         'CritIn' ~ 'Combat' + 'Race' + 'Sex' + 'Officer',
         'PTSD' ~ 'CritIn' + 'ID1u' + 'Race' + 'Sex' + 'Officer',
         'MI' ~ 'CritIn' + 'ID1u' + 'Race' + 'Sex' + 'Officer',
         'SES_u' ~ 'Race',
         'Officer' ~ 'SES_u',
         
         exposure = 'MI', 
         outcome = 'ID2')


ggdag::tidy_dagitty(dag_demos)

coordinates(dag_demos) <- list(
  x = c(CritIn = .5, MilFam = .6,  Combat = .75, MI = .75, ID1u = .65, PTSD = .75, ID2 = 1,
        Race = .58, Sex = .62, Officer = .67, SES_u = .59),
  y = c(ID1u = 1.09, MilFam = 1.15, PTSD = 1.03, ID2 = 1, MI = .97,  Combat = 1.25, CritIn = 1,
        Race = .93, Sex = .93, Officer = .90, SES_u = .86))

ggdag(dag_demos) + 
  geom_dag_point(colour = 'white') + 
  geom_dag_edges() + 
  geom_dag_text(color = 'black', size = 5) + 
  theme_dag()

adjustmentSets(dag_demos)

ggdag_adjustment_set(dag_demos)
```



### 4b. Years of Servive and Separation
Finally, consider how years of service and separation are involved

Age is a "cause" of both years of service and separation -- you cannot servce another year without living another year.
Years of Separation is therefore a function of age and years of service -- if you serve another year, you do not gain a year of separation. 

The more important question is, how do these variables relate to the DAG? Especially to military identity?



```{r, echo = FALSE}

dag_years <- 
  
  dagify('ID2' ~ 'MI' + 'PTSD' + 'Combat' + 'ID1u' + 'Race' + 'Sex' + 'Officer' + 'Yrs_Sep' + 'Yrs_Serv',
         'ID1u' ~ 'Combat' + 'MilFam' + 'Race' + 'Sex' + 'Officer',
         'CritIn' ~ 'Combat' + 'Race' + 'Sex' + 'Officer' + 'Yrs_Serv',
         'PTSD' ~ 'CritIn' + 'ID1u' + 'Race' + 'Sex' + 'Officer',
         'MI' ~ 'CritIn' + 'ID1u' + 'Race' + 'Sex' + 'Officer',
         'SES_u' ~ 'Race',
         'Officer' ~ 'SES_u',
         'Combat' ~ 'Yrs_Serv',
         
         'Yrs_Sep' ~ 'Age' + 'Yrs_Serv',
         'Yrs_Serv' ~ 'Age',
         
         exposure = 'MI', 
         outcome = 'ID2')


ggdag::tidy_dagitty(dag_years)

coordinates(dag_years) <- list(
  x = c(CritIn = .5, MilFam = .6,  Combat = .75, MI = .75, ID1u = .65, PTSD = .75, ID2 = 1,
        Race = .58, Sex = .64, Officer = .67, SES_u = .6, Yrs_Serv = .7, Yrs_Sep = .8, Age = .75),
  y = c(ID1u = 1.09, MilFam = 1.15, PTSD = 1.03, ID2 = 1, MI = .97,  Combat = 1.25, CritIn = 1,
        Race = .9, Sex = .92, Officer = .85, SES_u = .77, Yrs_Serv = 1.4, Yrs_Sep = 1.4, Age = 1.5))

ggdag(dag_years) + 
  geom_dag_point(colour = 'white') + 
  geom_dag_edges() + 
  geom_dag_text(color = 'black', size = 5) + 
  theme_dag()

adjustmentSets(dag_years)

ggdag_adjustment_set(dag_years)
```

# What models?

Run for both Loss outcome and Dissonance outcome

0. Null
1. Bivariate
2a. Adjust for Combat and PTSD
2b. Adjust for Critical Incidents
3a. Cannot run the adjusted model 3a without the unmeasured identity at time 1. DAG 3a shows that models 2a and 2b are biased -- we know that from cross sectional data anyways, but this DAG encodes the problem in the graph. We know the models 2a and 2b will contain error for unmeasured military identity at time 1)
3b1. Critical Incidents as the explanatory instead of Moral Injury symptoms. Control for combat. 
3b2. Critical Incidents as instrumental variable for Moral Injury symptoms. Control for combat. 
3c1. Moral Injury symptoms as the explanatory variable, with coming from a military family as a proxy for Identity at time 1, which is needed for either adjustment set (Military Family, Combat and PSTD)
3c2. Same as above but other adjustment set (Military Family, Critical Incident)
4a. Add demographics to model 3c. Officer + Rank + Sex
4b1. Add years of service and years of separation to DAG results in two adjustment sets. First, adjust for: Combat, ID1u/Military Family, Officer, PTSD, Race, Sex, Yrs_Serv
4b2. Adjust for:  CritIn, ID1u/Military Family, Officer, Race, Sex

That's 10 models, not counting the null. And if the analysis is done for Dissonance and Loss, then that's 20 models. 3 have alternative adjustment sets (2, 3c, 4b), so I can choose one or the other (probable PTSD and Combat instead of critical incidents). That leaves 7/14 models. Better. 4b1 is basically the same as 4a but with an extra variable, I will drop 4b1.


























# DAG analysis is used to find sets of covariates

Military Identity as outcome -- to assess identity loss hypothesis)
0a. Null Model - Military Identity ~ 1
0b. Null Model - Identity Dissonance ~ 1

1a. Bivariate  - Military Identity ~ MIOS Symptoms
1b. Bivariate  - Identity Dissonance ~ MIOS Symptoms

At this point, I would like to add the adjustment sets, however they call for the unobserved military identity at time 1 (e.g., during service, at the moment of a critical incident).  The DAGs suggest a different strategy <- using exposure to a critical incident  (i.e., potentially morally injurious event) as an instrumental variable. 

Also, the DAGs suggest that controlling for some antecedents -- gender, sex/gender, and officer status -- may serve a proxies for military identity at time 1 (also are likely associated with observed military identity).

That said, I can continue the analysis using MIOS symptoms, but I suspect this is flawed. To adjust, I can use MI events (critical incidents) as an independent variable -- or perhaps as an instrumental variable


2a. Adjustment Set - Military Identity ~ MIOS Symptoms + Combat (missing unobserved military identity at time 1)
2b. Adjustment Set - Identity Dissonance ~ MIOS Symptoms + Combat (missing unobserved military identity at time 1)

3a. Adjustment Set + Covariates - Military Identity ~ MIOS Symptoms + Combat + Race + Sex + Officer
3b. Adjustment Set + Covariates - Identity Dissonance ~ MIOS Symptoms + Combat + Race + Sex + Officer 

4a. Robust Explanatory Var - Military Identity    ~ MIOS Event + Combat + Race + Sex + Officer
4b. Robust Explanatory Var - Identity Dissonance  ~ MIOS Event + Combat + Race + Sex + Officer

5a. Instrumental Var + Adjust - Military Identity    ~ MIOS Symptoms + Combat | MIOS Event + Combat 
5b. Instrumental Var + Adjust - Identity Dissonance  ~ MIOS Symptoms + Combat | MIOS Event + Combat

6a. Instrumental Var + Cntrls - Military Identity    ~ MIOS Symptoms + Combat + Race + Sex + Officer | MIOS Event + Combat + Race + Sex + Officer
6b. Instrumental Var + Cntrls - Identity Dissonance  ~ MIOS Symptoms + Combat + Race + Sex + Officer | MIOS Event + Combat + Race + Sex + Officer

I don't want to do too much, but I want to be thorough


Mostly, the DAGs suggest I don't need to analyze loss as a control as
it is a mediator of MI symptoms and identity dissonance. 
